# Transfer ownership for Jellyfin playlists: Enable editing again!

> [!IMPORTANT]
> This utility is only for **Jellyfin < 10.11**, which are the versions that still use a SQLite for their databases.

> [!NOTE]
> This utility is only tested for **Linux** deployments of Jellyfin, as well as Kubernetes and Docker deployments.

## Contents

- [Introduction](#introduction)
- [Installation](#installation)
- [Usage](#usage)
- [Examples](#examples)
- [Containerized setups](#have-a-docker-or-kubernetes-based-setup)

## Introduction

This is a small utility that fixes the issue where playlists cannot be edited, when loaded automatically from XML files generated by a previous installation. This happens because the Jellyfin Server sets the `OwnerUserId` value to the nil UUID (`00000000000000000000000000000000`), which means it not owned by anyone, so it exists as read-only to all users (even administrators).

### Why doesn't editing the XML playlist files work?

You would think that a simple change in the XML files that (seem to) define playlists would be sufficient. But no! The value in that file is *overwriten* by a value in the SQLite database file `library.db` (in `<Jellyfin data directory>/data/` on Unix-like deployments) upon a library rescan. 

### So I can just update the database to change playlist ownership?

Sort of. Pretty much all the data and metadata (sans the actual audio and video files) is in the TypedBaseItems table of the library database. This table includes the information on essentially every piece of media in your library, and it has a column called OwnerID. So updating this field for the desired playlist object would change the ownership, right?

Wrong again! The *real* ownership value is buried in a massive JSON file, stored as a BLOB in the `data` field of that table (yes, the column is literally just called "data") on a given playlist's row. 

So here's what you would need to do to change the ownership of a playlist named `CoolSongs` to a user `emma`:

1. Query the database for the `data` field of the row with `name = 'CoolSongs'`

2. Copy out this text to somewhere you can edit it (the SQLite client typically converts the BLOB to text for you)

3. Now we need emma's ID. Open a browser and go to your administrator Dashboard > Users > emma 

4. Look in the URL on the emma's page, and find the field of the query string `userId`, and copy that value. I'll call this value `$USERID`

5. Go back to your JSON file/text/object, and replace the `OwnerUserId` value in the JSON with the `$USERID`

6. Render the JSON file as an ASCII hexdump, and store that somewhere

7. Update the `data` field for `CoolSongs` using SQLite's [BLOB literal syntax](https://www.sqlite.org/lang_expr.html#literal_values_constants_) (`X'<hex ASXII text>'`)

But that's kind of a pain, isn't it? That's why this program exists, to streamline this hassle. 

### Why can't I use the API? Wouldn't that be simpler?

It would be &mdash; if it worked. API tokens will not work with the `/Playlists` endpoint ([open issue](https://github.com/jellyfin/jellyfin/issues/12999), [discussion](https://github.com/orgs/jellyfin/discussions/12868)), and from my experience, simply using the browser session token gives exactly the same error (a 403 Forbidden error from the server). This utility does use the API, but only to get user IDs from usernames (which is a different endpoint, of course).

You can even see in the source code that all the server does is check if `OwnerUserId == UserId`, and checks if the user is in the playlist's shares, and neglects the case where the `OwnerUserId` is simply a nil UUID ([source](https://github.com/jellyfin/jellyfin/blob/d28ee6d71415b4c1f5c158f30f427b6952b8d65b/Jellyfin.Api/Controllers/PlaylistsController.cs#L132)).

### Will I always have to use this script to fix this issue?

Hopefully not! I want to work on a PR that fixes this issue at at the source, by taking all `playlist.xml` files found on the first library scan of a new installation, and assigning their ownership to the administrator if the `OwnerUserID` in the file does not belong to a known user. This will at least let someone edit the playlists.


## Installation

This project is structured as a Python library, so it can be installed with `pip` or `pipx`, or `uv`. Each of these provide the CLI program `jfchownpl` (see [Usage](#usage) section below). Poetry is also supported. 

Here's the installation for each of the tools:

### `pip` / `pipx`

(I'm using `pipx` below, but the commands are identical with `pip`)

```
git clone https://github.com/lmr97/jellyfin_chown_pl.git
pipx install ./jellyfin_chown_pl
```

### `uv`

```
git clone https://github.com/lmr97/jellyfin_chown_pl.git
uv tool install ./jellyfin_chown_pl
```


## Usage

### Before using: Get an API key

While the playlist ownership changes are done via database queries directly, this app still needs API access to get user IDs from usernames.

1. Open your browser and navigate to your administrator Dashboard

2. Go to the API Keys section and create a new API key.

3. Add this key to your shell environment as `JELLYFIN_API_KEY`:

    ```
    export JELLYFIN_API_KEY=<your key goes here>
    ```

    You can also add it to your shell startup environment (asuming you ran the previous command):

    ```
    echo "export JELLYFIN_API_KEY=$JELLYFIN_API_KEY" >> ~/.bashrc
    ```

### Usage (short form)

```
jfchownpl [-h] [-d DATABASE] -s SERVER_URL (-p PLAYLISTS | --all-playlists | --all-unowned) -u USER [-v] [--debug]
```

### Options

Short option | Long option | Description
---- | ---- | ----
`-h` | `--help` | Show help message and exit
`-d DATABASE` | `--database DATABASE` | The path to the library.db SQLite database. Will try to read from the [default Jellyfin Data Directory](https://jellyfin.org/docs/general/administration/configuration/#data-directory) if omitted.
`-s SERVER_URL` | `--server-url SERVER_URL` | The URL to your Jellyfin server.
`-p PLAYLIST` | `--playlist PLAYLIST` | The name of the playlist for which to change ownership (case sensitive). This option can be repeated for multiple playlists.
(none) | `--all-playlists` | Change ownership of *all* the server's playlists, regardless of current owner, to the user specified with `--user`. Cannot be used with `--playlist` or `--all-unowned`.
(none) | `--all-unowned` | Change ownership of all the server's playlists which belong to an unknown user to the user specified with `--user`. This covers the nil UUID case, and any playlists that have a user ID that don't belong to an existing user, but preserves ownership for playlists belonging to existing users. Cannot be used with `--playlist` or `--all-playlists`.
`-u USER` | `--user USER` | The user who will be the new owner of (all) the given playlist(s).Only one user can be specified: to map different playlists todifferent users, this program must be executed once for eachdistinct user.
`-v` | `--version` | Print version and exit.
(none) | `--debug` | This option lets the program crash fully, so a stacktrace will be printed to the console. Closes database connection if open.

## Examples

### Transfer all playlist ownerships to one user (emma)

This can make all your playlists editable if they've been migrated as read-only.

**Warning**: This will make playlists uneditable by their previous users (perhaps unless it's shared).

```
jfchownpl \
    --database /home/emma/jfdata/data/library.db \
    --server-url https://urjfserver.net \
    --user emma \
    --all-playlists
```

### Transfer one playlist's ownership

```
jfchownpl \
    --database /home/emma/jfdata/data/library.db \
    --server-url localhost:8096 \
    --user emma \
    --playlist CoolSongs
```


### Transfer multiple playlists' ownership

This example omits the database path, so the program will search for it in [one of the default data directory locations](https://jellyfin.org/docs/general/administration/configuration/#data-directory) specified in the Jellyfin documentation.

```
jfchownpl \
    --server-url localhost:8096 \
    --user emma \
    --playlist CoolSongs \ 
    --playlist "Even Cooler Songs"
```

## Have a Docker or Kubernetes-based setup?

See the [containers](./containers) folder in this repo for details on how to use this on a containerized setup.
